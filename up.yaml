---
- name: Setup MySQL Database and Import Data
  hosts: localhost
  become: yes
  tasks:
    - name: Install required packages
      apt:
        name: 
          - mysql-server
          - python3-mysqldb
        state: present
        update_cache: yes

    - name: Start MySQL service
      service:
        name: mysql
        state: started
        enabled: yes

    - name: Create MySQL database
      mysql_db:
        name: olist_db
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Create tables
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: |
          CREATE TABLE IF NOT EXISTS customers (
            customer_id VARCHAR(32) PRIMARY KEY,
            customer_unique_id VARCHAR(32),
            customer_zip_code_prefix VARCHAR(8),
            customer_city VARCHAR(64),
            customer_state CHAR(2)
          );

          CREATE TABLE IF NOT EXISTS geolocation (
            geolocation_zip_code_prefix VARCHAR(8),
            geolocation_lat DECIMAL(10,8),
            geolocation_lng DECIMAL(11,8),
            geolocation_city VARCHAR(64),
            geolocation_state CHAR(2)
          );

          CREATE TABLE IF NOT EXISTS order_items (
            order_id VARCHAR(32),
            order_item_id INT,
            product_id VARCHAR(32),
            seller_id VARCHAR(32),
            shipping_limit_date DATETIME,
            price DECIMAL(10,2),
            freight_value DECIMAL(10,2),
            PRIMARY KEY (order_id, order_item_id)
          );

          CREATE TABLE IF NOT EXISTS order_payments (
            order_id VARCHAR(32),
            payment_sequential INT,
            payment_type VARCHAR(16),
            payment_installments INT,
            payment_value DECIMAL(10,2),
            PRIMARY KEY (order_id, payment_sequential)
          );

          CREATE TABLE IF NOT EXISTS order_reviews (
            review_id VARCHAR(32) PRIMARY KEY,
            order_id VARCHAR(32),
            review_score INT,
            review_comment_title TEXT,
            review_comment_message TEXT,
            review_creation_date DATETIME,
            review_answer_timestamp DATETIME
          );

          CREATE TABLE IF NOT EXISTS orders (
            order_id VARCHAR(32) PRIMARY KEY,
            customer_id VARCHAR(32),
            order_status VARCHAR(16),
            order_purchase_timestamp DATETIME,
            order_approved_at DATETIME,
            order_delivered_carrier_date DATETIME,
            order_delivered_customer_date DATETIME,
            order_estimated_delivery_date DATETIME,
            FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
          );

          CREATE TABLE IF NOT EXISTS products (
            product_id VARCHAR(32) PRIMARY KEY,
            product_category_name VARCHAR(64),
            product_name_length INT,
            product_description_length INT,
            product_photos_qty INT,
            product_weight_g INT,
            product_length_cm INT,
            product_height_cm INT,
            product_width_cm INT
          );

          CREATE TABLE IF NOT EXISTS sellers (
            seller_id VARCHAR(32) PRIMARY KEY,
            seller_zip_code_prefix VARCHAR(8),
            seller_city VARCHAR(64),
            seller_state CHAR(2)
          );

          CREATE TABLE IF NOT EXISTS product_category_name_translation (
            product_category_name VARCHAR(64) PRIMARY KEY,
            product_category_name_english VARCHAR(64)
          );

    - name: Import customers data
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: "LOAD DATA INFILE '/var/lib/mysql-files/olist_customers_dataset.csv' INTO TABLE customers FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' IGNORE 1 LINES;"

    - name: Import geolocation data
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: "LOAD DATA INFILE '/var/lib/mysql-files/olist_geolocation_dataset.csv' INTO TABLE geolocation FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' IGNORE 1 LINES;"

    - name: Import order items data
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: "LOAD DATA INFILE '/var/lib/mysql-files/olist_order_items_dataset.csv' INTO TABLE order_items FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' IGNORE 1 LINES;"

    - name: Import order payments data
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: "LOAD DATA INFILE '/var/lib/mysql-files/olist_order_payments_dataset.csv' INTO TABLE order_payments FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' IGNORE 1 LINES;"

    - name: Import order reviews data
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: "LOAD DATA INFILE '/var/lib/mysql-files/olist_order_reviews_dataset.csv' INTO TABLE order_reviews FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' IGNORE 1 LINES;"

    - name: Import orders data
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: "LOAD DATA INFILE '/var/lib/mysql-files/olist_orders_dataset.csv' INTO TABLE orders FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' IGNORE 1 LINES;"

    - name: Import products data
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: "LOAD DATA INFILE '/var/lib/mysql-files/olist_products_dataset.csv' INTO TABLE products FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' IGNORE 1 LINES;"

    - name: Import sellers data
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: "LOAD DATA INFILE '/var/lib/mysql-files/olist_sellers_dataset.csv' INTO TABLE sellers FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' IGNORE 1 LINES;"

    - name: Import product category translation data
      mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        db: olist_db
        query: "LOAD DATA INFILE '/var/lib/mysql-files/product_category_name_translation.csv' INTO TABLE product_category_name_translation FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' IGNORE 1 LINES;" 